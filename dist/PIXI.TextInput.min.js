"use strict";var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),_get=function t(e,i,s){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,i);if(void 0===o){var n=Object.getPrototypeOf(e);return null===n?void 0:t(n,i,s)}if("value"in o)return o.value;var r=o.get;return void 0!==r?r.call(s):void 0};function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}!function(t){var e=function(e){function i(e,s){_classCallCheck(this,i);var o=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return o._input_style=Object.assign({position:"absolute",background:"none",border:"none",outline:"none",transformOrigin:"0 0",lineHeight:"0"},e),o._box_generator="function"==typeof s?s:new function(e){if((e=e||{fill:13421772}).default)e.focused=e.focused||e.default,e.disabled=e.disabled||e.default;else{var i=e;(e={}).default=e.focused=e.disabled=i}return function(i,s,o){var n=e[o.toLowerCase()],r=new t.Graphics;return n.fill&&r.beginFill(n.fill),n.stroke&&r.lineStyle(n.stroke.width||1,n.stroke.color||0,n.stroke.alpha||1),n.rounded?r.drawRoundedRect(0,0,i,s,n.rounded):r.drawRect(0,0,i,s),r.endFill(),r.closePath(),r}}(s),o._box_cache={},o._previous={},o._dom_added=!1,o._dom_visible=!0,o._placeholder="",o._placeholderColor=11119017,o._createDOMInput(),o.substituteText=!0,o._setState("DEFAULT"),o._addListeners(),o}return _inherits(i,t.Container),_createClass(i,[{key:"focus",value:function(){this._substituted&&!this.dom_visible&&this._setDOMInputVisible(!0),this._dom_input.focus()}},{key:"setInputStyle",value:function(t,e){this._input_style[t]=e,this._dom_input.style[t]=e,!this._substituted||"fontFamily"!==t&&"fontSize"!==t||this._updateFontMetrics(),this._last_renderer&&this._update()}},{key:"destroy",value:function(t){this.destroyBoxCache(),_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this,t)}},{key:"_createDOMInput",value:function(){this._dom_input=document.createElement("input"),this._dom_input.type="text";for(var t in this._input_style)this._dom_input.style[t]=this._input_style[t]}},{key:"_addListeners",value:function(){this.on("added",this._onAdded.bind(this)),this.on("removed",this._onRemoved.bind(this)),this._dom_input.addEventListener("keydown",this._onInputKeyDown.bind(this)),this._dom_input.addEventListener("input",this._onInputInput.bind(this)),this._dom_input.addEventListener("keyup",this._onInputKeyUp.bind(this)),this._dom_input.addEventListener("focus",this._onFocused.bind(this)),this._dom_input.addEventListener("blur",this._onBlurred.bind(this))}},{key:"_onInputKeyDown",value:function(t){this.emit("keydown",t.keyCode)}},{key:"_onInputInput",value:function(t){this.emit("input",this.text),this._substituted&&this._updateSubstitution()}},{key:"_onInputKeyUp",value:function(t){this.emit("keyup",t.keyCode)}},{key:"_onFocused",value:function(){this._setState("FOCUSED")}},{key:"_onBlurred",value:function(){this._setState("DEFAULT")}},{key:"_onAdded",value:function(){document.body.appendChild(this._dom_input),this._dom_input.style.display="none",this._dom_added=!0}},{key:"_onRemoved",value:function(){document.body.removeChild(this._dom_input),this._dom_added=!1}},{key:"_setState",value:function(t){this.state=t,this._updateBox(),this._substituted&&this._updateSubstitution()}},{key:"renderWebGL",value:function(t){_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"renderWebGL",this).call(this,t),this._render(t)}},{key:"renderCanvas",value:function(t){_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"renderCanvas",this).call(this,t),this._render(t)}},{key:"_render",value:function(t){this._resolution=t.resolution,this._last_renderer=t,this._canvas_bounds=this._getCanvasBounds(),this._needsUpdate()&&this._update()}},{key:"_update",value:function(){this._updateDOMInput(),this._substituted&&this._updateSurrogate(),this._updateBox()}},{key:"_updateBox",value:function(){this._needsNewBoxCache()&&this._buildBoxCache(),this.state==this._previous.state&&this._box==this._box_cache[this.state]||(this._box&&this.removeChild(this._box),this._box=this._box_cache[this.state],this.addChildAt(this._box,0),this._previous.state=this.state)}},{key:"_updateSubstitution",value:function(){"FOCUSED"===this.state?(this._dom_visible=!0,this._surrogate.visible=0===this.text.length):(this._dom_visible=!1,this._surrogate.visible=!0),this._updateDOMInput(),this._updateSurrogate()}},{key:"_updateDOMInput",value:function(){this._canvas_bounds&&(this._dom_input.style.top=this._canvas_bounds.top+"px",this._dom_input.style.left=this._canvas_bounds.left+"px",this._dom_input.style.transform=this._pixiMatrixToCSS(this._getDOMRelativeWorldTransform()),this._dom_input.style.opacity=this.worldAlpha,this._setDOMInputVisible(this.worldVisible&&this._dom_visible),this._previous.canvas_bounds=this._canvas_bounds,this._previous.world_transform=this.worldTransform.clone(),this._previous.world_alpha=this.worldAlpha,this._previous.world_visible=this.worldVisible)}},{key:"_needsUpdate",value:function(){return!this._comparePixiMatrices(this.worldTransform,this._previous.world_transform)||!this._compareClientRects(this._canvas_bounds,this._previous.canvas_bounds)||this.worldAlpha!=this._previous.world_alpha||this.worldVisible!=this._previous.world_visible}},{key:"_needsNewBoxCache",value:function(){var t=this._getDOMInputBounds();return!this._previous.input_bounds||t.width!=this._previous.input_bounds.width||t.height!=this._previous.input_bounds.height}},{key:"_createSurrogate",value:function(){this._surrogate_hitbox=new t.Graphics,this._surrogate_hitbox.interactive=!0,this._surrogate_hitbox.cursor="text",this._surrogate_hitbox.on("pointerdown",this._onSurrogateFocus.bind(this)),this.addChild(this._surrogate_hitbox),this._surrogate_mask=new t.Graphics,this.addChild(this._surrogate_mask),this._surrogate=new t.Text("",{}),this.addChild(this._surrogate),this._surrogate.mask=this._surrogate_mask,this._updateFontMetrics(),this._updateSurrogate()}},{key:"_updateSurrogate",value:function(){var t=this._deriveSurrogatePadding(),e=this._getDOMInputBounds();this._surrogate.style=this._deriveSurrogateStyle(),this._surrogate.style.padding=Math.max.apply(Math,t),this._surrogate.y=t[0]+this._font_metrics.top,this._surrogate.x=t[3],this._surrogate.text=this._deriveSurrogateText(),this._updateSurrogateHitbox(e),this._updateSurrogateMask(e,t)}},{key:"_updateSurrogateHitbox",value:function(t){this._surrogate_hitbox.clear(),this._surrogate_hitbox.beginFill(0,0),this._surrogate_hitbox.drawRect(0,0,t.width,t.height),this._surrogate_hitbox.endFill(),this._surrogate_hitbox.interactive=!this._disabled}},{key:"_updateSurrogateMask",value:function(t,e){this._surrogate_mask.clear(),this._surrogate_mask.beginFill(0),this._surrogate_mask.drawRect(e[3],0,t.width-e[3]-e[1],t.height),this._surrogate_mask.endFill()}},{key:"_destroySurrogate",value:function(){this._surrogate&&(this.removeChild(this._surrogate),this.removeChild(this._surrogate_hitbox),this._surrogate.destroy(),this._surrogate_hitbox.destroy(),this._surrogate=null,this._surrogate_hitbox=null)}},{key:"_onSurrogateFocus",value:function(){this._setDOMInputVisible(!0),setTimeout(this._ensureFocus.bind(this),10)}},{key:"_ensureFocus",value:function(){this._hasFocus()||this.focus()}},{key:"_deriveSurrogateStyle",value:function(){var e=new t.TextStyle;for(var i in this._input_style)switch(i){case"color":e.fill=this._input_style.color;break;case"fontFamily":case"fontSize":case"fontWeight":case"fontVariant":case"fontStyle":e[i]=this._input_style[i]}return 0===this._dom_input.value.length&&(e.fill=this._placeholderColor),e}},{key:"_deriveSurrogatePadding",value:function(){if(this._input_style.padding&&this._input_style.padding.length>0){var t=this._input_style.padding.trim().split(" ");if(1==t.length){var e=parseFloat(t[0]);return[e,e,e,e]}if(2==t.length){var i=parseFloat(t[0]),s=parseFloat(t[1]);return[i,s,i,s]}if(4==t.length)return t.map(function(t){return parseFloat(t)})}return[0,0,0,0]}},{key:"_deriveSurrogateText",value:function(){return 0===this._dom_input.value.length?this._placeholder:this._dom_input.value}},{key:"_updateFontMetrics",value:function(){var e=t.TextMetrics,i=this._deriveSurrogateStyle().toFontString(),s=e._canvas,o=e._context;o.font=i;var n="|Ã‰q"+e.BASELINE_SYMBOL,r=Math.ceil(o.measureText(n).width),u=Math.ceil(o.measureText(e.BASELINE_SYMBOL).width),a=2*u+5;u=u*e.BASELINE_MULTIPLIER|0,s.width=r,s.height=a,o.fillStyle="#f00",o.fillRect(0,0,r,a),o.font=i,o.textBaseline="top",o.fillStyle="#000",o.fillText(n,0,5);var _=o.getImageData(0,0,r,a).data,h=(_.length,4*r),d=0,l=0,c=!1;for(d=0;d<u;++d){for(var p=0;p<h;p+=4)if(255!==_[l+p]){c=!0;break}if(c)break;l+=h}this._font_metrics={top:d-5}}},{key:"_buildBoxCache",value:function(){this._destroyBoxCache();var t=["DEFAULT","FOCUSED","DISABLED"],e=this._getDOMInputBounds();for(var i in t)this._box_cache[t[i]]=this._box_generator(e.width,e.height,t[i]);this._previous.input_bounds=e}},{key:"_destroyBoxCache",value:function(){this._box&&(this.removeChild(this._box),this._box=null);for(var t in this._box_cache)this._box_cache[t].destroy(),this._box_cache[t]=null,delete this._box_cache[t]}},{key:"_hasFocus",value:function(){return document.activeElement===this._dom_input}},{key:"_setDOMInputVisible",value:function(t){this._dom_input.style.display=t?"block":"none"}},{key:"_getCanvasBounds",value:function(){var t=this._last_renderer.view.getBoundingClientRect(),e={top:t.top,left:t.left,width:t.width,height:t.height};return e.left+=window.scrollX,e.top+=window.scrollY,e}},{key:"_getDOMInputBounds",value:function(){var t=!1;this._dom_added||(document.body.appendChild(this._dom_input),t=!0);var e=this._dom_input.style.transform,i=this._dom_input.style.display;this._dom_input.style.transform="",this._dom_input.style.display="block";var s=this._dom_input.getBoundingClientRect();return this._dom_input.style.transform=e,this._dom_input.style.display=i,t&&document.body.removeChild(this._dom_input),s}},{key:"_getDOMRelativeWorldTransform",value:function(){var t=this._last_renderer.view.getBoundingClientRect(),e=this.worldTransform.clone();return e.scale(this._resolution,this._resolution),e.scale(t.width/this._last_renderer.width,t.height/this._last_renderer.height),e}},{key:"_pixiMatrixToCSS",value:function(t){return"matrix("+[t.a,t.b,t.c,t.d,t.tx,t.ty].join(",")+")"}},{key:"_comparePixiMatrices",value:function(t,e){return!(!t||!e)&&(t.a==e.a&&t.b==e.b&&t.c==e.c&&t.d==e.d&&t.tx==e.tx&&t.ty==e.ty)}},{key:"_compareClientRects",value:function(t,e){return!(!t||!e)&&(t.left==e.left&&t.top==e.top&&t.width==e.width&&t.height==e.height)}},{key:"substituteText",get:function(){return this._substituted},set:function(t){this._substituted!=t&&(this._substituted=t,t?(this._createSurrogate(),this._dom_visible=!1):(this._destroySurrogate(),this._dom_visible=!0),this.placeholder=this._placeholder,this._update())}},{key:"placeholder",get:function(){return this._placeholder},set:function(t){this._placeholder=t,this._substituted?(this._updateSurrogate(),this._dom_input.placeholder=""):this._dom_input.placeholder=t}},{key:"disabled",get:function(){return this._disabled},set:function(t){this._disabled=t,this._dom_input.disabled=t,this._setState(t?"DISABLED":"DEFAULT")}},{key:"text",get:function(){return this._dom_input.value},set:function(t){this._dom_input.value=t,this._substituted&&this._updateSurrogate()}}]),i}();t.TextInput=e}(PIXI);